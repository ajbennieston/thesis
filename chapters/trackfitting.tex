\chapter{Track Fitting}

\section{Introduction}
Track fitting is the process by which track parameters are determined from a collection of clustered hits. The track parameters include the trajectory, as well as kinematic variables such as the energy or momentum of the particle in question. Track fitting in particle physics is typically performed using a variant of the Kalman filter, which is the optimal estimator for the state of a discrete linear dynamic system.

Originally devised as a noise-reduction and signal filtering technique for communications, the Kalman filter determines optimal estimates of past, present and future states of a linear system based on a series of time-ordered measurements used in conjunction with a statistical model of the system and its measurement errors. It is used extensively for both track and vertex fitting in particle physics, most often in a magnetised detector, where it separates the curvature of a particle due to the magnetic field from the noise introduced by direction changes as a result of multiple scattering.

\section{The Icarus Kalman Filter}
The Icarus\citep{Amerio2004} experiment presented a Kalman filter which makes statistical use of the distribution of multiple scattering angle $\theta$ to measure the momentum of a particle in a non-magnetised detector\citep{Ankowski2006}. The Kalman filter is used to filter out the noise introduced by limited detector resolution. The details of the Icarus algorithm are presented here as an overview of the mechanism of action of the Kalman filter, but also as the basis for the Latte kalman filter, which aims to perform the same task.

The Kalman filter operates on a discrete set of states, each represented by a state vector $\vec{x}_k$. These states correspond to points on the track, and can in principle be measured anywhere along it. In practice, the track is split into segments of fixed length, and the endpoints of these segments define the set of planes at which the state vector $\vec{x}_k$ is evaluated. 

The track system is described by the linear equation:
\begin{equation}\label{eqn:kalman_track_system}
    \vec{x}_k^{-} = F_{k-1} \vec{x}_{k-1} + \vec{w}_{k-1}
\end{equation}
Here, $F_{k-1}$ is a matrix defining the propagation of the state vector from plane $k-1$ to plane $k$, $\vec{w}_{k-1}$ is the noise associated with this propagation (which is random, in liquid Argon) and acts to smear the state vector, $\vec{x}_{k-1}$ is the filtered state vector in plane $k-1$, and $\vec{x}_k^{-}$ is the predicted state vector in plane $k$.

The state vector is not usually observed directly; instead, quantities such as the scattering angle are observed, and these are related to quantities in the state vector (such as the particle momentum) through a transformation matrix:
\begin{equation}\label{eqn:kalman_measurement_equation}
    \vec{m}_k = H_k \vec{x}_k + \epsilon_k
\end{equation}
where $H_k$ is a matrix transforming a measurement vector $\vec{m}_k$ into a state vector $\vec{x}_k$, and $\vec{\epsilon}_k$ represents measurement noise (errors on the measurements).

The process noise $\vec{w}_k$ and the measurement noise $\vec{\epsilon}_k$ are taken to be unbiased and with finite variance. The covariance matrices are $Q_k$ (for process covariance) and $V_k$ (for measurement covariance). If the process and measurement noise are both random Gaussian variables, the Kalman filter will be the optimal estimator of the system state.

The Kalman filter proceeds through the following three steps, repeated for each new plane $k$ and its corresponding measurement $\vec{m}_k$.

\vspace{1em}\hrule\vspace{1em}
\begin{description}
    \item[1. Prediction:] Given the state vector $\vec{x}_{k-1}$ in plane $k-1$, the prediction step of the Kalman filter estimates the state vector in a future plane $k$, in the absence of noise. The state $\vec{x}_k^{-}$ is the predicted state at plane $k$, using the information contained in all of the state vectors up to $k-1$.
    \begin{equation}\label{eqn:kalman_prediction_step}
        \vec{x}_k^{-} = F_{k-1} \vec{x}_{k-1}
    \end{equation}

    \item[2. Filtering:] Given a predicted state vector $\vec{x}_k^{-}$ (or a suitable initial state), determine the present state $\vec{x}_k$ by taking into account the measurements of all previous planes (via the predicted state) and the current plane (via the measurement $\vec{m}_k$). Since the previous measurements are included via their contribution to the state vector, the Kalman filter automatically includes correlations between measurements.
    \begin{equation}\label{eqn:kalman_filtering_step}
        \vec{x}_k = \vec{x}_k^{-} + K_k \left(\vec{m}_k - H_k\vec{x}_k^{-} \right)
    \end{equation}
    where $K_k$ is the Kalman gain matrix, and is related to the covariance of the state vector and the measurement noise.

    \item[3. Smoothing:] When the filter is applied to plane $k+1$, a smoothing step can be used to improve the estimate of the state at plane $k$, taking into account all measurements up to and including $k+1$.
    \begin{equation}
        \vec{x}_k^{n} = \vec{x}_k + A_k \left(\vec{x}_{k+1}^n - \vec{x}_{k+1}^{-}\right)
    \end{equation}
    where $A_k$ is a smoothing gain matrix and $\vec{x}_k^n$ is the filtered state vector after smoothing, for plane $k$.
\end{description}
\vspace{1em}\hrule\vspace{1em}

For particles moving in a non-magnetised detector, the trajectory is split into small track segments, each fitted to a straight line. The state vector $\vec{x}_k$ contains the inverse momentum, coordinates, and track slopes:
\begin{equation}\label{eqn:kalman_state_vector}
    \vec{x}_k = \left( \begin{array}{c} \frac{1}{p} \\ x \\ y \\ \frac{dx}{dz} \\ \frac{dy}{dz} \end{array} \right)
\end{equation}

The transportation matrix $F_k$ provides a straight line extrapolation, with no changes to the track parameters. The energy deposited in a track segment (which can be determined from the charge collected) is subtracted from the momentum estimate in plane $k-1$ to update the momentum estimate in the state vector for plane $k$.

\begin{equation}\label{eqn:kalman_transportation_matrix}
    F_k = \left( \begin{array}{ccccc}
    \frac{1}{1-E_{\mathrm{dep}}/p}  &   0   &   0   &   0       &   0       \\
    0                               &   1   &   0   & \Delta z  &   0       \\
    0                               &   0   &   1   &   0       & \Delta z  \\
    0                               &   0   &   0   &   1       &   0       \\
    0                               &   0   &   0   &   0       &   1
    \end{array} \right)
\end{equation}

The measurement vector includes the coordinates and slopes, but not the inverse momentum. Instead, the angle $\theta_0$ between adjacent track segments at the plane $k$ is used. Equation \eqref{eqn:kalman_theta_p_relationship} relates this scattering angle to the momentum\citep{Eidelman2004}.
\begin{equation}\label{eqn:kalman_theta_p_relationship}
    \theta_0^{\mathrm{rms}} = \frac{13.6\MeV}{\beta c p} z \sqrt{\frac{l}{X_0}} \left(1 + 0.038\ln\left[\frac{l}{X_0}\right]\right)
\end{equation}
where $\beta$ is the velocity of the particle, $p$ is its momentum and $z$ is the charge, $X_0$ is the radiation length and $l$ the track segment length. The measurement vector $\vec{m}_k$ is then
\begin{equation}\label{eqn:kalman_measurement_vector}
    \vec{m}_k = \left( \begin{array}{c} \theta_0 \\ x \\ y \\ \frac{dx}{dz} \\ \frac{dy}{dz} \end{array} \right)
\end{equation}

The matrix $H_k$, which relates the measurement and state vectors, is given by:
\begin{equation}\label{eqn:kalman_measurement_matrix}
    H_k = \diag \left( C, 1, 1, 1, 1 \right)
\end{equation}
where $C$ is the constant multiplying $\displaystyle \frac{1}{p}$ in equation \eqref{eqn:kalman_theta_p_relationship}.

Finally, the covariance matrices $Q_k$ (for the system covariance) and $V_k$ (for the measurement covariance) must be taken into account. The Icarus experiment use system covariance matrices from \citep{Wolin1993}, where the covariances for multiple scattering are carefully derived, while the measurements are assumed to be uncorrelated, and the matrix $V$ is diagonal, with each component representing the measurement error.

\section{The Latte Kalman Filter}
The Latte Kalman filter follows closely the formulation used in the Icarus filter. The implementation is based on that present in the SciPy\citep{SciPy} package for scientific programming in the Python language, with a linear system corresponding to the track fitting mechanism used by Icarus.

The state vector $x_k$ is:
\begin{equation}\label{eqn:kalman_latte_state_vector}
    x_k = \left(\begin{array}{c}
        \frac{1}{p} \\ y \\ z \\ \frac{\Delta y}{\Delta x} \\ \frac{\Delta z}{\Delta x}
    \end{array}\right)
\end{equation}

The measurement vector is identical to the state vector, except for the scattering angle $\theta$ in place of the inverse momentum:
\begin{equation}\label{eqn:kalman_latte_measurement_vector}
    x_k = \left(\begin{array}{c}
        \theta \\ y \\ z \\ \frac{\Delta y}{\Delta x} \\ \frac{\Delta z}{\Delta x}
    \end{array}\right)
\end{equation}


The process covariance matrix $Q$ is a $5\times 5$ matrix defined as:\citep{Wolin1993}
\begin{equation}\label{eqn:kalman_process_covariance_matrix}
    Q = \left(
    \begin{array}{ccccc}

        \left(\frac{0.01}{p}\right)^2 &                 0 &                 0 &                0 &                0 \\
                                    0 & \Delta x^2 P_{33} & \Delta x^2 P_{34} & -\Delta x P_{33} & -\Delta x P_{34} \\
                                    0 & \Delta x^2 P_{34} & \Delta x^2 P_{44} & -\Delta x P_{34} & -\Delta x P_{44} \\
                                    0 & -\Delta x P_{33}  & -\Delta x P_{34}  & P_{33}           & P_{34}           \\
                                    0 & -\Delta x P_{34}  & -\Delta x P_{44}  & P_{34}           & P_{44}           

    \end{array}
    \right)
\end{equation}
where $p$ is the momentum at that step, $\Delta x$ is the segment length in the $x$ direction, and
\begin{align*}
    P_{33} &= \theta (1 + S_y^2)(1 + S_y^2 + S_z^2) \\
    P_{34} &= \theta S_y S_z(1 + S_y^2 + S_z^2) \\
    P_{44} &= \theta (1 + S_z^2)(1 + S_y^2 + S_z^2)
\end{align*}
where $\theta$ is the scattering angle, and $\displaystyle S_y=\frac{\Delta y}{\Delta x}$ and $\displaystyle S_z = \frac{\Delta z}{\Delta x}$ are the slopes in $y$ and $z$.

The measurement covariance matrix is diagonal, with components representing the measurement uncertainties on the values of $\theta$, $y$, $z$, $\displaystyle\frac{\Delta y}{\Delta x}$ and $\displaystyle\frac{\Delta z}{\Delta x}$ respectively:
\begin{equation}\label{eqn:kalman_measurement_covariance_matrix}
    V = \diag \left( 1\times10^{-4}, ~ 0.1, ~ 0.1, ~ 1\times10^{-3}, ~ 1\times10^{-3} \right)
\end{equation}

Tracks are split into segments of $200\mm$, with the Kalman filter applied to the points between two segments, and using the slopes of those segments to determine the scattering angle $\theta$. The $200\mm$ segment lengths are chosen to be six times the $50\mm$ radius used for a smoothing process which reduces the total number of hits in the track, replacing groups of hits with a single charge-weighted hit. The track momentum is taken from the first component of the state vector after running along the entire track.

