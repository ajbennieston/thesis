\chapter{Track Fitting}

\section{Introduction}
Track fitting is the process by which track parameters are determined from a collection of clustered hits. The track parameters include the trajectory, as well as kinematic variables such as the energy or momentum of the particle in question. Track fitting in particle physics is typically performed using a variant of the Kalman filter, which is the optimal estimator for the state of a discrete linear dynamic system.

Originally devised as a noise-reduction and signal filtering technique for communications, the Kalman filter determines optimal estimates of past, present and future states of a linear system based on a series of time-ordered measurements used in conjunction with a statistical model of the system and its measurement errors. It is used extensively for both track and vertex fitting in particle physics, most often in a magnetised detector, where it separates the curvature of a particle due to the magnetic field from the noise introduced by direction changes as a result of multiple scattering.

\section{The Icarus Kalman Filter}
The Icarus\citep{Amerio2004} experiment presented a Kalman filter which makes statistical use of the distribution of multiple scattering angle $\theta$ to measure the momentum of a particle in a non-magnetised detector\citep{Ankowski2006}. The Kalman filter is used to filter out the noise introduced by limited detector resolution. The details of the Icarus algorithm are presented here as an overview of the mechanism of action of the Kalman filter, but also as the basis for the Latte kalman filter, which aims to perform the same task.

The Kalman filter operates on a discrete set of states, each represented by a state vector $\vec{x}_k$. These states correspond to points on the track, and can in principle be measured anywhere along it. In practice, the track is split into segments of fixed length, and the endpoints of these segments define the set of planes at which the state vector $\vec{x}_k$ is evaluated. 

The track system is described by the linear equation:
\begin{equation}\label{eqn:kalman_track_system}
    \vec{x}_k^{-} = F_{k-1} \vec{x}_{k-1} + \vec{w}_{k-1}
\end{equation}
Here, $F_{k-1}$ is a matrix defining the propagation of the state vector from plane $k-1$ to plane $k$, $\vec{w}_{k-1}$ is the noise associated with this propagation (which is random, in liquid Argon) and acts to smear the state vector, $\vec{x}_{k-1}$ is the filtered state vector in plane $k-1$, and $\vec{x}_k^{-}$ is the predicted state vector in plane $k$.

The state vector is not usually observed directly; instead, quantities such as the scattering angle are observed, and these are related to quantities in the state vector (such as the particle momentum) through a transformation matrix:
\begin{equation}\label{eqn:kalman_measurement_vec}
    \vec{m}_k = H_k \vec{x}_k + \epsilon_k
\end{equation}
where $H_k$ is a matrix transforming a measurement vector $\vec{m}_k$ into a state vector $\vec{x}_k$, and $\vec{\epsilon}_k$ represents measurement noise (errors on the measurements).

The process noise $\vec{w}_k$ and the measurement noise $\vec{\epsilon}_k$ are taken to be unbiased and with finite variance. The covariance matrices are $Q_k$ (for process covariance) and $V_k$ (for measurement covariance). If the process and measurement noise are both random Gaussian variables, the Kalman filter will be the optimal estimator of the system state.

The Kalman filter proceeds through the following three steps, repeated for each new plane $k$ and its corresponding measurement $\vec{m}_k$.

\begin{description}
    \item[Prediction:] Given the state vector $\vec{x}_{k-1}$ in plane $k-1$, the prediction step of the Kalman filter estimates the state vector in a future plane $k$, in the absence of noise. The state $\vec{x}_k^{-}$ is the predicted state at plane $k$, using the information contained in all of the state vectors up to $k-1$.
    \begin{equation}\label{eqn:kalman_prediction_step}
        \vec{x}_k^{-} = F_{k-1} \vec{x}_{k-1}
    \end{equation}

    \item[Filtering:] Given a predicted state vector $\vec{x}_k^{-}$, determine the present state $\vec{x}_k$ by taking into account the measurements of all previous planes (via the predicted state) and the current plane (via the measurement $\vec{m}_k$). Since the previous measurements are included via their contribution to the state vector, the Kalman filter automatically includes correlations between measurements.
    \begin{equation}\label{eqn:kalman_filtering_step}
        \vec{x}_k = \vec{x}_k^{-} + K_k \left(\vec{m}_k - H_k\vec{x}_k^{-} \right)
    \end{equation}
    where $K_k$ is the Kalman gain matrix, and is related to the covariance of the state vector and the measurement noise.

    \item[Smoothing:] When the filter is applied to plane $k+1$, a smoothing step can be used to improve the estimate of the state at plane $k$, taking into account all measurements up to and including $k+1$.
    \begin{equation}
        \vec{x}_k^{n} = \vec{x}_k + A_k \left(\vec{x}_{k+1}^n - \vec{x}_{k+1}^{-}\right)
    \end{equation}
    where $A_k$ is a smoothing gain matrix and $\vec{x}_k^n$ is the filtered state vector after smoothing, for plane $k$.
\end{description}


